package tantoo_login;

import java.io.IOException;
import java.io.Serializable;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;

import javax.faces.bean.ManagedBean;
import javax.faces.bean.RequestScoped;
import javax.faces.context.ExternalContext;
import javax.faces.context.FacesContext;
import javax.servlet.http.HttpSession;

@ManagedBean
@RequestScoped
public class Login implements Serializable {

	private static final long serialVersionUID = 1L;
	private final String connection_url ="jdbc:postgresql://localhost:5432/TantooDB";

	private String user;
	private String pwd;
	private String email;
	private String description;
	
	
	public String getPwd() {
		return pwd;
	}
	public void setPwd(String pwd) {
		this.pwd = pwd;
	}
	public String getUser() {
		return user;
	}
	public void setUser(String user) {
		this.user = user;
	}
	
	public String getEmail() {
		return email;
	}
	public void setEmail(String email) {
		this.email = email;
	}

	public String getDescription() {
		return description;
	}
	
	public void setDescription(String description) {
		this.description = description;
	}
	
	
	public String checkLogin() {
		List<Character_test> list = getCharacters(this.user,this.pwd,email,description);
		System.out.println(list.size());
		
		for(int i= 0; i< list.size();i++) {
			
			if(this.user.equals(list.get(i).getName()) && this.pwd.equals(list.get(i).getPassword())) {
				return "success";
			}	
		}
		
		return "failure";
	}
	
	public List<Character_test> getCharacters(String name, String password, String mail, String desc) {
		List<Character_test> result = new ArrayList<>();
	
		try {
			Class.forName("org.postgresql.Driver").newInstance();
			Properties user = new Properties();
			user.put("user", "postgres");
			user.put("password", "admin");
			
			Connection con = DriverManager.getConnection(connection_url,user);
			
			try {
				String sql = 
						"select * from users where name='" + name + "' AND password='" + password + "';";
				PreparedStatement stat = con.prepareStatement(sql);
				
				ResultSet rs = null;
				//rs = stat.getResultSet(); according to the slides
				rs = stat.executeQuery();
				
				while(rs.next()) {
					
					Character_test chr = new Character_test();
				
					chr.setName(rs.getString(1));
					chr.setPassword(rs.getString(2));
					chr.setEmail(rs.getString(3));
					chr.setDescription(rs.getString(4));
					
					result.add(chr);
				}
			} finally {
				con.close();
			}
		} catch (SQLException e) {
			e.printStackTrace();
		} catch (InstantiationException e) {
			e.printStackTrace();
		} catch (IllegalAccessException e) {
			e.printStackTrace();
		} catch (ClassNotFoundException e) {
			e.printStackTrace();
		}
		return result;
	}
	
	public void logout() throws IOException {
		
	    setUser(null);
	    setPwd(null);
	    setEmail(null);
	    setDescription(null);
	    FacesContext fc = FacesContext.getCurrentInstance();
	    HttpSession session = (HttpSession)fc.getExternalContext().getSession(false);
	    session.invalidate();
	    FacesContext.getCurrentInstance().getExternalContext().redirect("http://localhost:8080/tantoo/faces/index.xhtml");
	    
	    
	}

}
